# WebClient 엔드포인트만 인증이 안되는 문제
다른 엔드포인트는 PermitAll 설정을 하지 않아도 문제없이 JWT 토큰으로 인증이 되었는데
WebClient를 사용하는 엔드포인트들만 맞는 토큰을 Authorization 헤더에 넣어도 인증이 되지 않는 문제가 발생했다.

확인해본 결과 AuthenticationFilter 까지 가는건 확인했는데 그 이후 AuthEntryPoint로가서 바로 에러처리가 되는것을 확인했다.

그러던중 WebClient의 비동기 처리 방식과 Spring Security의 인증 방식이 충돌하기 때문이라는 정보를 찾았다.
## 문제 원인: 스레드 변경으로 인한 인증 정보 유실
1. 클라이언트가 Bearer 토큰과 함께 API를 요청하면, AuthenticationFilter가 **톰캣 스레드 (A 스레드)**에서 실행되어 토큰을 검증하고 사용자 인증 정보를 SecurityContextHolder에 저장합니다. 이 인증 정보는 A 스레드에만 연결되어 있습니다.
2. PlaceApiService에서 WebClient를 사용하여 외부 API를 호출하면, WebClient는 비동기적으로 동작하며 **별도의 다른 스레드 (B 스레드)**에서 네트워크 작업을 처리합니다.
3. 코드의 실행 흐름이 A 스레드에서 B 스레드로 넘어갈 때, A 스레드에만 묶여 있던 사용자 인증 정보가 B 스레드로 전달되지 않습니다.
결과적으로, WebClient가 작업을 처리하는 B 스레드에서는 사용자가 '인증되지 않은 상태'가 되어버리고, 이로 인해 Spring Security가 접근을 차단하고 AuthEntryPoint가 401 Unauthorized 오류를 발생시키는 것입니다.

## 해결 방안: contextCapture()로 인증 정보 전파하기
이 문제를 해결하려면, WebClient가 새로운 스레드에서 작업을 시작할 때 현재 스레드의 인증 정보(SecurityContext)를 함께 전달해주어야 합니다. Spring Boot 3에서는 이 컨텍스트 전파(Context Propagation)를 매우 간단하게 처리할 수 있습니다.
WebClientConfig.java 파일에서 WebClient Bean을 생성할 때, .contextCapture() 설정을 추가하기만 하면 됩니다.

## 문제 발생: contextCapture()가 버전 차이 때문에 불러올 수 없음
이 오류는 Spring Boot 3.x 버전으로 올라오면서 SecurityContext를 비동기 환경에 전파하는 방식이 변경되었기 때문에 발생합니다. 이전에는 spring-security-config에 포함된 기능이었지만, 이제는 micrometer-context-propagation 이라는 별도의 라이브러리를 통해 이 기능이 제공됩니다.

## 해결 방안: build.gradle 파일에 context-propagation 라이브러리 의존성을 추가하면 문제가 해결됩니다.
```build.gradle
implementation 'io.micrometer:context-propagation:latest.release'
```

## 문제 발생: build.gradle에 의존성 추가해도 불러올 수 없음
Spring Boot의 의존성 관리 기능(io.spring.dependency-management)을 사용하기 때문에, 특별히 버전을 명시하지 않아도 Spring Boot 3.5.7 버전에 맞게 호환되는 버전이 자동으로 결정됨
## 해결 방안: 의존성 버전명시 제거
```build.gradle
implementation 'io.micrometer:context-propagation'
```

## 문제 발생: 버전명시 제거해도 불러올 수 없음
contextCapture()를 사용하려면, io.micrometer:context-propagation 외에 반드시 Reactor와 연동해 주는 io.micrometer:micrometer-context-propagation 의존성을 추가해야 함
## 해결 방안: Reactor 타입에 contextCapture() 메서드를 추가하는 라이브러리 추가
```build.gradle
implementation 'io.micrometer:micrometer-context-propagation'
```


## 해결 방안
추가했던 의존성 삭제
WebClient에 `.contextCapture()` 추가하는게 아닌 Service구역에서 `.contextCapture()` 추가

## 문제 발생
implementation 'io.micrometer:micrometer-context-propagation:1.2.0'
찾을 수 없다는 문제 발생
## 해결 방안
implementation 'io.micrometer:micrometer-context-propagation:1.2.0'
implementation 'io.micrometer:micrometer-observation-reactor:1.2.0'

위에서 아래껄로 변경

