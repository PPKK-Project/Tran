name: Deploy Backend & Frontend to GCP VM (Docker CI/CD)

on:
  push:
    branches:
      - main # main Î∏åÎûúÏπòÏóê ÏΩîÎìúÍ∞Ä Ìë∏ÏãúÎê† ÎïåÎßàÎã§ ÏûêÎèô Ïã§Ìñâ

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  AR_REPO_NAME: tlan-repo
  AR_LOCATION: asia-northeast3
  VM_NAME: ${{ secrets.VM_NAME }}
  VM_ZONE: ${{ secrets.VM_ZONE }}
  SSH_USER: mentki3

jobs:
  # ------------------------------------------------------------------
  # CI (Continuous Integration): Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Î∞è Artifact RegistryÏóê Ìë∏Ïãú
  # ------------------------------------------------------------------
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4
      
      # 1. GCP Ïù∏Ï¶ù (AR Î∞è VM Ï†ëÏÜç Í∂åÌïú ÌöçÎìù)
      - name: üîë Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          
      # 2. Docker Ïù∏Ï¶ù ÏÑ§Ï†ï (Artifact Registry Î°úÍ∑∏Ïù∏)
      - name: üê≥ Set up Docker auth
        run: gcloud auth configure-docker ${{ env.AR_LOCATION }}-docker.pkg.dev

      # 3. Backend ÎπåÎìú Î∞è Ìë∏Ïãú
      - name: Build & Push Backend
        run: |
          BACKEND_TAG="${{ env.AR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO_NAME }}/teamproject-backend:latest"
          docker build --no-cache -t teamproject-backend:latest ./BACK
          docker tag teamproject-backend:latest $BACKEND_TAG
          docker push $BACKEND_TAG

      # 4. Frontend ÎπåÎìú Î∞è Ìë∏Ïãú
      - name: Build & Push Frontend
        run: |
          FRONTEND_TAG="${{ env.AR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO_NAME }}/teamproject-frontend:latest"
          docker build --no-cache -t teamproject-frontend:latest ./FRONT/teamproject
          docker tag teamproject-frontend:latest $FRONTEND_TAG
          docker push $FRONTEND_TAG

  # ------------------------------------------------------------------
  # CD (Continuous Delivery): VMÏóê Ï†ëÏÜçÌïòÏó¨ Ïª®ÌÖåÏù¥ÎÑà ÏóÖÎç∞Ïù¥Ìä∏ Î∞è Ïû¨Ïã§Ìñâ
  # ------------------------------------------------------------------
  deploy:
    needs: build-and-push # CI Îã®Í≥Ñ ÏôÑÎ£å ÌõÑ Ïã§Ìñâ
    runs-on: ubuntu-latest
    steps:
      - name: üîë Authenticate for Deployment
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: üîÑ Deploy Containers via SSH
        # gcloud compute sshÎ•º ÏÇ¨Ïö©ÌïòÏó¨ VMÏóê Î™ÖÎ†π Ïã§Ìñâ
        run: |
          BACKEND_TAG="${{ env.AR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO_NAME }}/teamproject-backend:latest"
          FRONTEND_TAG="${{ env.AR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO_NAME }}/teamproject-frontend:latest"
          DB_PASSWORD='qwer1234'

          # 1. VMÏóêÏÑú ÏµúÏã† Docker Ïù¥ÎØ∏ÏßÄ Pull
          echo "Pulling latest images on VM..."
          gcloud compute ssh ${{ env.VM_NAME }} --zone ${{ env.VM_ZONE }} --command "
            gcloud auth configure-docker asia-northeast3-docker.pkg.dev;
            docker pull $BACKEND_TAG; 
            docker pull $FRONTEND_TAG
          "
          # 2. Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Î™®Îëê Í∞ïÏ†ú ÏÇ≠Ï†ú
          echo "Removing existing containers..."
          gcloud compute ssh ${{ env.VM_NAME }} --zone ${{ env.VM_ZONE }} --command "
            docker rm -f frontend-app spring-boot-app mariadb-server
          "
          # 3. ÏÉàÎ°úÏö¥ Ïª®ÌÖåÏù¥ÎÑà Ïû¨Ïã§Ìñâ (DB -> Backend -> Frontend ÏàúÏÑú)
          echo "Restarting containers with latest images..."
          gcloud compute ssh ${{ env.VM_NAME }} --zone ${{ env.VM_ZONE }} --command "
            docker run -d --name mariadb-server --network my-app-network -p 3306:3306 \
            -e MARIADB_ROOT_PASSWORD='$DB_PASSWORD' -e MARIADB_DATABASE='tlandb' \
            -v mariadb_data:/var/lib/mysql mariadb:latest ;
            # Backend Ïª®ÌÖåÏù¥ÎÑà Ïû¨Ïã§Ìñâ
            docker run -d -p 8080:8080 --network my-app-network --name spring-boot-app \
            -e SPRING_DATASOURCE_URL='jdbc:mariadb://mariadb-server:3306/tlandb' \
            -e SPRING_DATASOURCE_USERNAME='root' \
            -e SPRING_DATASOURCE_PASSWORD='$DB_PASSWORD' \
            -e SPRING_DATASOURCE_DRIVER_CLASS_NAME='org.mariadb.jdbc.Driver' \
            $BACKEND_TAG ;
            # Frontend Ïª®ÌÖåÏù¥ÎÑà Ïû¨Ïã§Ìñâ
            docker run -d -p 80:80 --network my-app-network --name frontend-app $FRONTEND_TAG
          "
          echo "Deployment complete! Check VM status."